function Rect(t,e,i,s,r){this.left=t,this.top=e,this.right=i,this.bottom=s,this.color=r}function TimeRecord(t,e,i,s){this.timestampMsec=t,this.durationMsec=e,this.object=i,this.color=s}const INTERVAL_MIN_1=6e4,INTERVAL_MIN_5=3e5,INTERVAL_MIN_15=9e5,INTERVAL_MIN_30=18e5,INTERVAL_HOUR_1=36e5,INTERVAL_HOUR_6=216e5,INTERVAL_HOUR_12=432e5,INTERVAL_DAY_1=864e5,INTERVAL_DAY_7=6048e5,OFFSET_TOP_BOTTOM=25;function Timeline(t){var e=new Date;if(t)this.options=t;else{this.options={timelines:1,colorTimeBackground:"#C62828",colorTimeText:"#FFFFFF"}}this.resetRects(),this.timelineSelected=0,this.selectedMsec=e.getTime(),this.intervalMsec=INTERVAL_HOUR_1,this.gmtOffsetInMillis=6e4*-e.getTimezoneOffset(),this.density=1,this.requestMoreBackgroundDataCallback=null,this.requestMoreMajor1DataCallback=null,this.requestMoreMajor2DataCallback=null,this.timeSelectedCallback=null,this.liveCallback=null,this.timerSelectedId=-1,this.isLive=!1,this.recordsMajor1=new Array(this.options.timelines),this.recordsMajor2=new Array(this.options.timelines),this.recordsBackground=new Array(this.options.timelines),this.rectNoData=new Array(this.options.timelines);for(var i=0;i<this.options.timelines;i++)this.recordsMajor1[i]=[],this.recordsMajor2[i]=[],this.recordsBackground[i]=[],this.rectNoData[i]=null}function updateCanvasDpi(t,e){if(devicePixelRatio=window.devicePixelRatio||1,backingStoreRatio=t.webkitBackingStorePixelRatio||t.mozBackingStorePixelRatio||t.msBackingStorePixelRatio||t.oBackingStorePixelRatio||t.backingStorePixelRatio||1,ratio=devicePixelRatio/backingStoreRatio,"undefined"==typeof auto&&(auto=!0),auto&&devicePixelRatio!==backingStoreRatio){var i=e.width,s=e.height;e.width=i*ratio,e.height=s*ratio,e.style.width=i+"px",e.style.height=s+"px",t.scale(ratio,ratio)}}function msToTime(t){var e=t%1e3,i=(t=(t-e)/1e3)%60,s=(t=(t-i)/60)%60;return(t-s)/60+":"+s+":"+i+"."+e}function isToday(t){return(new Date).toDateString()==t.toDateString()}Timeline.prototype.setCurrentTimeline=function(t){t<this.options.timelines&&t>=0&&(this.timelineSelected=t)},Timeline.prototype.getCurrentTimeline=function(){return this.timelineSelected},Timeline.prototype.getTotalTimelines=function(){return this.options.timelines},Timeline.prototype.setCurrent=function(t){this.selectedMsec=Math.min(t,(new Date).getTime())},Timeline.prototype.getCurrent=function(){return this.selectedMsec},Timeline.prototype.setCurrentWithAnimation=function(t){var e=this.selectedMsec,i=this;const s=(this.selectedMsec-t)/15;var r=setInterval(function(){e-=s,i.setCurrent(e),i.draw()},10);setTimeout(function(){clearInterval(r),i.setCurrent(t),i.draw()},150)},Timeline.prototype.setCanvas=function(t){this.canvas=t},Timeline.prototype.setMajor1Records=function(t,e){t>this.options.timelines-1?console.error("Out of index ["+t+"/"+(this.options.timelines-1)+"] on setMajor1Records()"):this.recordsMajor1[t]=e},Timeline.prototype.getMajor1Records=function(t){return this.recordsMajor1[t]},Timeline.prototype.setMajor2Records=function(t,e){t>this.options.timelines-1?console.error("Out of index ["+t+"/"+(this.options.timelines-1)+"] on setMajor2Records()"):this.recordsMajor2[t]=e},Timeline.prototype.getMajor2Records=function(t){return this.recordsMajor2[t]},Timeline.prototype.setBackgroundRecords=function(t,e){t>this.options.timelines-1?console.error("Out of index ["+t+"/"+(this.options.timelines-1)+"] on setBackgroundRecords()"):this.recordsBackground[t]=e},Timeline.prototype.getBackgroundRecords=function(t){return this.recordsBackground[t]},Timeline.prototype.setRequestMoreBackgroundDataCallback=function(t){this.requestMoreBackgroundDataCallback=t},Timeline.prototype.setRequestMoreMajor1DataCallback=function(t){this.requestMoreMajor1DataCallback=t},Timeline.prototype.setRequestMoreMajor2DataCallback=function(t){this.requestMoreMajor2DataCallback=t},Timeline.prototype.setTimeSelectedCallback=function(t){this.timeSelectedCallback=t},Timeline.prototype.setLiveCallback=function(t){this.liveCallback=t},Timeline.prototype.runTimeSelectedCallbackDelayed=function(){var t=this;clearTimeout(this.timerSelectedId),this.timerSelectedId=setTimeout(function(){let e=t.getCurrentTimeline();var i=t.getRecord(t.selectedMsec,t.recordsBackground[e]);t.timeSelectedCallback(e,t.selectedMsec,i)},500)},Timeline.prototype.getNextRecord=function(t,e){var i=null;for(record of e){if(null!=i&&t<i.timestampMsec&&t>=record.timestampMsec)return i;i=record}return null},Timeline.prototype.getPrevRecord=function(t,e){for(record of e)if(record.timestampMsec<t)return record;return null},Timeline.prototype.getRecord=function(t,e){for(record of e)if(t>=record.timestampMsec&&t<record.timestampMsec+record.durationMsec)return record;return null},Timeline.prototype.getNextMajorRecord=function(t){return this.getNextRecord(this.selectedMsec,this.recordsMajor1[t])},Timeline.prototype.getPrevMajorRecord=function(t){return this.getPrevRecord(this.selectedMsec-3e4,this.recordsMajor1[t])},Timeline.prototype.setIntervalWithAnimation=function(t){var e=this.intervalMsec,i=this;const s=(this.intervalMsec-t)/15;var r=setInterval(function(){e-=s,i.intervalMsec=e,i.draw()},10);setTimeout(function(){clearInterval(r),i.intervalMsec=t,i.draw()},150)},Timeline.prototype.getInterval=function(){return this.intervalMsec},Timeline.prototype.increaseInterval=function(){this.intervalMsec>864e5-1?this.setIntervalWithAnimation(6048e5):this.intervalMsec>432e5-1?this.setIntervalWithAnimation(864e5):this.intervalMsec>216e5-1?this.setIntervalWithAnimation(432e5):this.intervalMsec>INTERVAL_HOUR_1-1?this.setIntervalWithAnimation(216e5):this.intervalMsec>18e5-1?this.setIntervalWithAnimation(INTERVAL_HOUR_1):this.intervalMsec>9e5-1?this.setIntervalWithAnimation(18e5):this.intervalMsec>3e5-1?this.setIntervalWithAnimation(9e5):this.intervalMsec>59999?this.setIntervalWithAnimation(3e5):this.setIntervalWithAnimation(6e4)},Timeline.prototype.decreaseInterval=function(){this.intervalMsec>6048e5-1?this.setIntervalWithAnimation(864e5):this.intervalMsec>864e5-1?this.setIntervalWithAnimation(432e5):this.intervalMsec>432e5-1?this.setIntervalWithAnimation(216e5):this.intervalMsec>216e5-1?this.setIntervalWithAnimation(INTERVAL_HOUR_1):this.intervalMsec>INTERVAL_HOUR_1-1?this.setIntervalWithAnimation(18e5):this.intervalMsec>18e5-1?this.setIntervalWithAnimation(9e5):this.intervalMsec>9e5-1?this.setIntervalWithAnimation(3e5):this.intervalMsec>3e5-1&&this.setIntervalWithAnimation(6e4)},Timeline.prototype.resetRects=function(){this.rectMajor1Selected=null,this.rectMajor2Selected=null,this.rectsMajor1=new Array(this.options.timelines),this.rectsMajor2=new Array(this.options.timelines),this.rectsBackground=new Array(this.options.timelines);for(var t=0;t<this.options.timelines;t++)this.rectsMajor1[t]=[],this.rectsMajor2[t]=[],this.rectsBackground[t]=[]},Timeline.prototype.updateRects=function(t){var e,i=25*this.density,s=this.canvas.clientWidth,r=(this.canvas.clientHeight-2*i)/this.options.timelines,o=r*t+i,n=this.selectedMsec-this.intervalMsec/2,a=this.selectedMsec+this.intervalMsec/2,c=s/this.intervalMsec;for(e of(this.rectNoData[t]=new Rect(0,2+o,Math.min(((new Date).getTime()-n)*c,s),r-4),this.recordsMajor1[t])){if(e.timestampMsec+e.durationMsec>=n&&e.timestampMsec<=a)(l=new Rect(Math.max((e.timestampMsec-n)*c,0),2+o,Math.min((e.timestampMsec-n+e.durationMsec)*c,s),r-4,e.color)).right-l.left<1&&(l.right+=1),null==this.rectMajor1Selected&&t==this.timelineSelected&&this.selectedMsec>=e.timestampMsec&&this.selectedMsec<e.timestampMsec+e.durationMsec?this.rectMajor1Selected=l:this.rectsMajor1[t].push(l)}this.recordsMajor1[t].length>0&&(n<(e=this.recordsMajor1[t][this.recordsMajor1[t].length-1]).timestampMsec&&null!=this.requestMoreMajor1DataCallback&&this.requestMoreMajor1DataCallback(t));for(e of this.recordsMajor2[t])if(e.timestampMsec+e.durationMsec>=n&&e.timestampMsec<=a){var l=new Rect(Math.max((e.timestampMsec-n)*c,0),4+o,Math.min((e.timestampMsec-n+e.durationMsec)*c,s),r-8,e.color);null==this.rectMajor2Selected&&t==this.timelineSelected&&this.selectedMsec>=e.timestampMsec&&this.selectedMsec<e.timestampMsec+e.durationMsec?this.rectMajor2Selected=l:this.rectsMajor2[t].push(l)}this.recordsMajor2[t].length>0&&(n<(e=this.recordsMajor2[t][this.recordsMajor2[t].length-1]).timestampMsec&&null!=this.requestMoreMajor2DataCallback&&this.requestMoreMajor2DataCallback(t));for(e of this.recordsBackground[t]){if(e.timestampMsec+e.durationMsec>=n&&e.timestampMsec<=a)(l=new Rect(Math.max((e.timestampMsec-n)*c,0),2+o,Math.min((e.timestampMsec-n+e.durationMsec)*c,s),r-4,e.color)).right-l.left<1&&(l.right+=1),this.rectsBackground[t].push(l)}this.recordsBackground[t].length>0&&(n<(e=this.recordsBackground[t][this.recordsBackground[t].length-1]).timestampMsec&&null!=this.requestMoreBackgroundDataCallback&&this.requestMoreBackgroundDataCallback(t))},Timeline.prototype.updateResize=function(){updateCanvasDpi(this.canvas.getContext("2d"),this.canvas)},Timeline.prototype.drawCurrentTimeDate=function(t){t.save();var e=new Date;e.setTime(this.selectedMsec);(new Date).getTime();let i=!1;i=(new Date).getTime()-this.selectedMsec<1e3,t.font="12px sans-serif";let s=i&&null!=this.liveCallback;(s||this.isLive)&&this.liveCallback(this.timelineSelected,s),this.isLive=s;var r=s?"LIVE":i?"Now":e.formatDateHourMinSec(),o=t.measureText(r).width,n=this.canvas.clientWidth/2-o/2;t.fillStyle=this.options.colorTimeBackground,t.fillRect(n-2,0,o+4,18),t.fillStyle=this.options.colorTimeText,t.fillText(r,n,14),r=isToday(e)?"Today":e.toLocaleDateString(),o=t.measureText(r).width,n=this.canvas.clientWidth-o-4,t.fillText(r,n,14),t.restore()},Timeline.prototype.getRulerScale=function(){return this.intervalMsec>6048e5-1?"7 days":this.intervalMsec>864e5-1?"1 day":this.intervalMsec>432e5-1?"12 hours":this.intervalMsec>216e5-1?"6 hours":this.intervalMsec>INTERVAL_HOUR_1-1?"1 hour":this.intervalMsec>18e5-1?"30 min":this.intervalMsec>9e5-1?"15 min":this.intervalMsec>3e5-1?"5 min":this.intervalMsec>59999?"1 min":""},Date.prototype.formatDateHourMin=function(){var t=this.getHours(),e=this.getMinutes();return(t<10?"0":"")+t+":"+(e<10?"0":"")+e},Date.prototype.formatDateHourMinSec=function(){var t=this.getHours(),e=this.getMinutes(),i=this.getSeconds();return(t<10?"0":"")+t+":"+(e<10?"0":"")+e+":"+(i<10?"0":"")+i},Date.prototype.formatShortDate=function(){return this.toLocaleString("en-us",{month:"short"})+" "+this.getDate()},Timeline.prototype.drawHoursMinutes=function(t,e,i){var s=this.selectedMsec-this.intervalMsec/2+this.gmtOffsetInMillis,r=this.selectedMsec+this.intervalMsec/2+this.gmtOffsetInMillis;if(s+this.selectedMsec%i<r){var o=this.intervalMsec/i,n=s%i,a=t.measureText("__00:00__").width;if(o*a<this.canvas.clientWidth){var c=n*e,l=this.intervalMsec*e,h=i*e,m=this.canvas.clientHeight,d=25*this.density;t.fillStyle=this.options.colorDigits,t.strokeStyle=this.options.colorDigits,t.save(),t.beginPath();for(var u=0;u<o;u++){var M=new Date;M.setTime(s-n+(u+1)*i-this.gmtOffsetInMillis);var p=M.formatDateHourMin();"00:00"===p?(p=M.formatShortDate(),t.font="bold 10px sans-serif"):t.font="10px sans-serif";var f=l-(c+(o-u-1)*h);a=t.measureText(p).width,t.fillText(p,f-a/2,m-d/1.7),t.moveTo(f,m-d/5),t.lineTo(f,m-d/2.5),(f-=h/2)>0&&(t.moveTo(f,m-d/5),t.lineTo(f,m-d/4)),u==o-1&&(f+=h)}return t.stroke(),t.restore(),!0}}},Timeline.prototype.drawRuler=function(t){var e=this.canvas.clientWidth/this.intervalMsec;this.drawHoursMinutes(t,e,6e4)||this.drawHoursMinutes(t,e,3e5)||this.drawHoursMinutes(t,e,9e5)||this.drawHoursMinutes(t,e,18e5)||this.drawHoursMinutes(t,e,INTERVAL_HOUR_1)||this.drawHoursMinutes(t,e,216e5)||this.drawHoursMinutes(t,e,432e5)||this.drawHoursMinutes(t,e,864e5);var i=this.getRulerScale();t.measureText(i).width;t.fillStyle=this.options.colorDigits,t.fillText(i,4,12)},Timeline.prototype.onSingleTapUp=function(t){var e=t.offsetX-this.canvas.clientWidth/2,i=this.intervalMsec/this.canvas.clientWidth*e;if(this.options.timelines>0){var s=t.offsetY-25;if(s>0&&t.offsetY<this.canvas.clientHeight-25){var r=(this.canvas.clientHeight-50)/this.options.timelines,o=Math.floor(s/r);this.timelineSelected!=o&&(this.timelineSelected=o)}}var n=this.selectedMsec+i,a=!1;for(record of this.recordsMajor2[this.timelineSelected])if(n>=record.timestampMsec&&n<=record.timestampMsec+record.durationMsec){n=record.timestampMsec,a=!0;break}if(!a){var c=null;for(record of this.recordsMajor1[this.timelineSelected]){if(n>=record.timestampMsec&&n<=record.timestampMsec+record.durationMsec){n=record.timestampMsec;break}if(null!=c&&n>record.timestampMsec+record.durationMsec&&n<c.timestampMsec){n=c.timestampMsec;break}c=record}}this.setCurrentWithAnimation(n),this.draw(),this.runTimeSelectedCallbackDelayed()},Timeline.prototype.onScroll=function(t){var e;e=this.intervalMsec/this.canvas.clientWidth*t,this.setCurrent(this.getCurrent()-e),this.draw(),this.runTimeSelectedCallbackDelayed()},Timeline.prototype.draw=function(){this.resetRects();for(var t=0;t<this.options.timelines;t++)this.updateRects(t);var e=this.canvas.getContext("2d");dimensions={top:0,left:0,width:this.canvas.clientWidth,height:this.canvas.clientHeight},e.fillStyle=this.options.colorBackground,e.fillRect(0,0,dimensions.width,dimensions.height);for(t=0;t<this.options.timelines;t++){for(rect of(this.options.timelines>1&&t==this.timelineSelected&&(e.fillStyle=this.options.colorTimelineSelected,e.fillRect(this.rectNoData[t].left-2,this.rectNoData[t].top-2,this.rectNoData[t].right-this.rectNoData[t].left+4,this.rectNoData[t].bottom+4)),e.fillStyle=this.options.colorRectNoData,e.fillRect(this.rectNoData[t].left,this.rectNoData[t].top,this.rectNoData[t].right-this.rectNoData[t].left,this.rectNoData[t].bottom),this.rectsBackground[t]))e.fillStyle=null==rect.color?this.options.colorRectBackground:rect.color,e.fillRect(rect.left,rect.top,rect.right-rect.left,rect.bottom);for(rect of this.rectsMajor1[t])e.fillStyle=null==rect.color?this.options.colorRectMajor1:rect.color,e.fillRect(rect.left,rect.top,rect.right-rect.left,rect.bottom);for(rect of(null!=this.rectMajor1Selected&&(e.fillStyle=this.options.colorMajor1Selected,e.fillRect(this.rectMajor1Selected.left,this.rectMajor1Selected.top,this.rectMajor1Selected.right-this.rectMajor1Selected.left,this.rectMajor1Selected.bottom)),this.rectsMajor2[t]))e.fillStyle=null==rect.color?this.options.colorRectMajor2:rect.color,e.fillRect(rect.left,rect.top,rect.right-rect.left,rect.bottom);if(null!=this.rectMajor2Selected&&(e.fillStyle=this.options.colorMajor2Selected,e.fillRect(this.rectMajor2Selected.left,this.rectMajor2Selected.top,this.rectMajor2Selected.right-this.rectMajor2Selected.left,this.rectMajor2Selected.bottom)),e.fillStyle=this.options.colorTimeBackground,e.fillRect(this.canvas.clientWidth/2,0,2,this.canvas.clientHeight),null!=this.options.timelineNames&&t<this.options.timelineNames.length){let r=12;this.options.timelines>1&&t==this.timelineSelected?(e.fillStyle=this.options.colorTimelineSelected,e.globalAlpha=.9):(e.fillStyle=this.options.colorBackground,e.globalAlpha=.6);var i=e.measureText(this.options.timelineNames[t]).width,s=this.rectNoData[t].top+this.rectNoData[t].bottom/2+r/2;e.fillRect(2,s-r,i+4,r+6),e.globalAlpha=1,e.fillStyle=this.options.colorTimeText,e.fillText(this.options.timelineNames[t],4,s)}this.drawRuler(e),this.drawCurrentTimeDate(e)}};
